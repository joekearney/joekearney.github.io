---
layout: post
title: 'How to: JMX in a DMZ'
categories:
- work
tags:
- code
- jmx
status: publish
type: post
author: Joe Kearney
---
<p>We want to manage a Java web server running in a DMZ using JMX. Here we describe how to set this up, with JMX access from clients over SSH. My <a title="SSH tunnel into a DMZ" href="/posts/jmx-ssh-tunnelling-into-a-dmz/">last post describes</a> how to set up connect to a port in the DMZ through an SSH tunnel (yes, it's simple). Once we have that, JMX-managed apps can be configured to allow JMX clients to connect to the source-host of the tunnel.</p>
<p><!--more--></p>
<p>This post is in part a distillation of information found in Oracle blog posts <a title="Oracle: JMX - connection through firewalls" href="https://blogs.oracle.com/jmxetc/entry/jmx_connecting_through_firewalls_using" target="_blank">[1]</a><a title="Oracle - RMI Connectors, Single Port, SSL, and Firewall" href="https://blogs.oracle.com/jmxetc/entry/java_5_premain_rmi_connectors" target="_blank">[2]</a> from 2007/8 with some contributions from <a title="Mark Feeney - JMX through a ssh tunnel" href="http://blog.markfeeney.com/2010/10/jmx-through-ssh-tunnel.html" target="_blank">this one</a>, and some of my own trial-and-error testing.</p>
<h1>How are JMX connections established?</h1>
<ol>
<li>Managed application starts an RMI registry and binds JMX connection details in it under the name <code>jmxrmi</code></li>
<li>Client asks the RMI registry in the managed application for JMX connection details</li>
<li>RMI registry responds with <code>java.rmi.server.hostname:jmxPort</code> (from below)</li>
<li>Client connects to whatever host:port it was given</li>
</ol>
<h1>Two ports</h1>
<p>You can probably persuade your friendly but stubborn sysadmin to open one (outbound) port through the firewall, but a second will be tricky. A standard JMX config uses two ports:</p>
<ol>
<li><strong>RMI registry</strong>
<ul>
<li>specified by the <code>com.sun.management.jmxremote.port</code> system property</li>
<li>or given explicitly in <code>LocateRegistry.createRegistry(specifiedPort)</code></li>
</ul>
</li>
<li><strong>Used to export JMX RMI connection objects</strong>
<ul>
<li>dynamically allocated when the JMX connection server is created</li>
<li>served to clients who ask the RMI registry for it</li>
</ul>
</li>
</ol>
<p>Usually you don't need to know the dynamic port used here until runtime, but obviously this isn't going to fly when connecting through a well-secured firewall.</p>
<p>You can specify that the connection server factory should use the same port for these two roles when creating the JMX connection server programmatically in the <code>JMXServiceURL</code>, for example:</p>
<blockquote>
<pre>service:jmx:rmi://&lt;jmxHost:jmxPort&gt;/jndi/rmi://&lt;rmiHost:rmiPort&gt;/jmxrmi</pre>
</blockquote>
<p>Here the first port is that used for exported JMX RMI connection objects and the second port is where the RMI registry listens. The value of <code>jmxHost</code> here is ignored always.</p>
<h1>Three addresses</h1>
<p>There are many addresses that can be configured in various places.</p>
<ol>
<li>The system property <code>java.rmi.server.hostname</code> (<a title="Oracle - java.rmi properties documentation" href="http://docs.oracle.com/javase/7/docs/technotes/guides/rmi/javarmiproperties.html" target="_blank">Oracle docs</a>). Contrary to some writings, this has nothing to do with where any listeners are established, so this can basically anything. This is the address that clients are given by the RMI registry, to which they attempt to make JMX connections. <strong>So this should be the name of the host originating the SSH tunnel.</strong></li>
<li><code>jmxHost</code> in the <code>JMXServiceURL</code>, which is always ignored</li>
<li><code>rmiHost</code> in the <code>JMXServiceURL</code> has to be resolvable by the managed application. Setting this to be 127.0.0.1, localhost or the machine name all appear to do the same thing, namely to bind to all interfaces on the machine.</li>
<li>If the JMX/RMIConnectorServer is created and bound into the RMI registry manually, you'll specify the host in new instance of <code>JMXServiceURL</code>. In that case the <code>rmiHost</code> above is ignored.</li>
</ol>
<h1>Points of sadness</h1>
<p>Nowhere with this relatively simple setup can you define the bind address of the RMI registry; it always seems to bind to <code>0.0.0.0</code>. Still, you can use iptables to prevent access to the port except from that host, and the SSH tunnel will do the rest.</p>
<p>The <code>java.rmi.server.hostname</code> property is defined VM-wide; it's not respected if passed in as the new connector server's environment. So this might not be appropriate for applications using RMI in other ways. Though if you're already running an app in a DMZ and using RMI to connect home, either you already know that and have solved these problems, or you're completely insane.</p>
